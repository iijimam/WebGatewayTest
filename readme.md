# Apacheã‚³ãƒ³ãƒ†ãƒŠã®HTTPSåŒ–ï¼‹IRIS for Healthã¸ã®æ¥ç¶šã‚µãƒ³ãƒ—ãƒ«

- â€»1 ã‚µãƒ³ãƒ—ãƒ«ã§ã¯IRIS2022.2ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚[iris](/iris/)ä»¥ä¸‹ã« iris.keyã‚’é…ç½®ã™ã‚Œã°ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚­ãƒ¼ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã™ã€‚
- â€»2 ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³åˆ©ç”¨æ™‚ã¯ã€[docker-compose.yml](docker-compose.yml) 19è¡Œç›®ã‚’ã‚³ãƒ¡ãƒ³ãƒˆåŒ–ï¼ˆ#ï¼‰ã—ã€IRISã®[Dockerfile](/iris/Dockerfile)ã®FROMã®ã‚³ãƒ³ãƒ†ãƒŠã‚’é©åˆ‡ãªã‚‚ã®ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

## ã‚³ãƒ³ãƒ†ãƒŠã®é–‹å§‹

```
docker-compose up -d --build
```
Apacheã‚³ãƒ³ãƒ†ãƒŠå†…ã®80ãƒãƒ¼ãƒˆã¯ãƒ›ã‚¹ãƒˆã®**8080**ã«ã€443ã¯**8443**ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚

ã‚µãƒ³ãƒ—ãƒ«ã® [docker-compose.yml](/docker-compose.yml) ã‚’ä¿®æ­£ã›ãšã«ãã®ã¾ã¾ã‚³ãƒ³ãƒ†ãƒŠã‚’é–‹å§‹ã—ãŸå ´åˆã¯ã€ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ã¸ã¯ä»¥ä¸‹ã®URLã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

é€šä¿¡æ–¹å¼|URL
--|--
http|http://localhost:8080/csp/sys/UtilHome.csp
https|https://localhost:8443/csp/sys/UtilHome.csp

ãƒ¦ãƒ¼ã‚¶åï¼šSuperUserã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼šSYSã€€ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

## ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢

```
docker-compose stop
```

## ã‚³ãƒ³ãƒ†ãƒŠå‰Šé™¤
```
docker-compose down
```
___

**ã€Apacheã®ã‚³ãƒ³ãƒ†ãƒŠã«ã¤ã„ã¦è£œè¶³ã€‘**

ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã€ä¸‹è¨˜ã‚³ãƒ³ãƒ†ãƒŠã‚’åˆ©ç”¨ã€‚ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œã§80ãƒãƒ¼ãƒˆã®ApacheãŒç«‹ã¡ä¸ŠãŒã‚‹ã€‚

`containers.intersystems.com/intersystems/webgateway:2022.2.0.372.0`


IRISã®ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ç”¨ã«ã“ã®Apacheã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€IRISã¸æ¥ç¶šã‚’è¡Œã†ãŸã‚ã®ãƒ‘ã‚¹ã®è¿½åŠ ãŒå¿…è¦ã€‚

## 1) Apacheã‚³ãƒ³ãƒ†ãƒŠã®confãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã™ã‚‹

Apacheã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã€ä»¥ä¸‹ã«IRISç”¨ã®confãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã€‚

`/etc/apache2/mods-available/CSP.conf`

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çŠ¶æ…‹ã§ã¯IRISã®ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ç”¨è¨­å®šãŒè¡Œã‚ã‚Œã¦ã„ãªã„ãŸã‚ã€/ ã®ãƒ‘ã‚¹ãŒæ¥ãŸã¨ãApacheã‹ã‚‰Webã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã«è»¢é€ã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã‚’è¿½åŠ ã™ã‚‹ã€‚

è¿½åŠ å†…å®¹ã¯[webgateway.conf](/web/webgwfiles/webgateway.conf)ã®ä¸­èº«

Apacheç”¨[Dockerfile](/web/Dockerfile) ã®RUNã®è¡Œã§CSP.confã«[webgateway.conf](/web/webgwfiles/webgateway.conf)ã®ä¸­èº«ã‚’è¿½è¨˜ã—ã¦ã„ã‚‹ï¼ˆ5è¡Œç›®ï¼‰ã€‚

## 2) Webã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‹ã‚‰IRISã¸æ¥ç¶šã™ã‚‹ãŸã‚ã®è¨­å®šè¿½åŠ 

ï¼ˆãƒ¡ãƒ¢ï¼šApacheã‚³ãƒ³ãƒ†ãƒŠç«‹ã¡ä¸Šã’å¾Œã«æ‰‹å‹•ã§Webã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ç®¡ç†ç”»é¢ã§ã‚‚è¨­å®šã§ãã‚‹ã€€ğŸ‘‰ã€€[http://webã‚µãƒ¼ãƒå/csp/bin/Systems/Module.cxw](http://localhost:8080/csp/bin/Systems/Module.cxw)ï¼‰

> ã“ã®ã‚³ãƒ³ãƒ†ãƒŠã¯80ãƒãƒ¼ãƒˆã‚’ãƒ›ã‚¹ãƒˆã®**8080**ã«å‰²ã‚Šå½“ã¦ã¦ã„ã¾ã™ã€‚

CSP.iniãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’æ›¸ãæ›ãˆã‚Œã°ã‚ˆã„ã®ã§ã€æ›¸ãæ›ãˆã®ä¸­èº«ã®ã¿ã‚’ [CSP.ini](/web/webgwfiles/CSP.ini)ã«ç”¨æ„

ã‚³ãƒ³ãƒ†ãƒŠã§ã¯CSP.iniãƒ•ã‚¡ã‚¤ãƒ«ã¯Webã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã«é…ç½®ã•ã‚Œã‚‹ã€‚

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ç’°å¢ƒå¤‰æ•° **${ISC_PACKAGE_INSTALLDIR}** ã§ç¢ºèªã§ãã‚‹ã€‚

```
root@318a6f20db77:/opt/webgateway# ls ${ISC_PACKAGE_INSTALLDIR}/bin/CSP.ini
/opt/webgateway/bin/CSP.ini
```
ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰æ™‚ã€IRISã¸ã®æ¥ç¶šè¨­å®šã‚’ **${ISC_PACKAGE_INSTALLDIR}/bin/CSP.ini** ã«è¿½è¨˜ã™ã‚‹ã‚ˆã†ã« Apacheç”¨[Dockerfile](/web/Dockerfile) ã®6è¡Œç›®ã®RUNã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œï¼ˆå®Ÿè¡Œå†…å®¹ã¯ä»¥ä¸‹ï¼‰
```
cat /etc/apache2/mods-available/webgwfiles/CSP.ini >> ${ISC_PACKAGE_INSTALLDIR}/bin/CSP.ini && \
```

ã“ã“ã¾ã§ã§ã€80ï¼ˆãƒ›ã‚¹ãƒˆå´ã¯8080ï¼‰ã§IRISã¸æ¥ç¶šã‚’è¡Œã†è¨­å®šã¯å®Œäº†ã€‚

ï¼œãƒ¡ãƒ¢1ï¼
ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã€æ¥ç¶šå…ˆã‚‚ã‚³ãƒ³ãƒ†ãƒŠã®IRISã‚’æŒ‡ã—ã¦ã„ã‚‹ã€‚

- æ¥ç¶šå…ˆIRISã®ãƒ›ã‚¹ãƒˆåï¼š**iris4h**
- ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚µãƒ¼ãƒãƒ¼ãƒãƒ¼ãƒˆï¼š**1972**
- ã‚¢ã‚¯ã‚»ã‚¹ãƒ¦ãƒ¼ã‚¶åï¼š**CSPSystem**
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼š**SYS**
- CSP.iniã«è¨˜è¼‰ã™ã‚‹IRISã¸ã®æ¥ç¶šåã¯ **[LOCAL]** ã‚’åˆ©ç”¨ã€‚ã‚µãƒ¼ãƒåã¨ã—ã¦è¨­å®šã—ãŸ[LOCAL]ã«å¯¾ã—ã¦ã€**LOCAL=Enabled** ã®è¨˜è¿°ã‚‚å¿…è¦
- **æ¥ç¶šå…ˆIRISã®CSPSystemã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒã‚µãƒ³ãƒ—ãƒ«ã¨ç•°ãªã‚‹å ´åˆã¯ã€ [CSP.ini](/web/webgwfiles/CSP.ini) 16è¡Œç›®ã®å¤‰æ›´ãŒå¿…è¦ã€‚**

ï¼œãƒ¡ãƒ¢2ï¼
IRISã‚³ãƒ³ãƒ†ãƒŠå´ã§ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰æ™‚äº‹å‰å®šç¾©ãƒ¦ãƒ¼ã‚¶ã«å¯¾ã™ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’SYSã«å›ºå®šã¨ã—ã¦ã„ã¾ã™ã€‚é©å®œå¤‰æ›´ãŠé¡˜ã„ã—ã¾ã™ã€‚
>IRISã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹[Dockerfile](/iris/Dockerfile) ã§å®Ÿè¡Œã—ã¦ã„ã‚‹ [iris.script](/iris/iris.script)å†…ã§ã€åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®äº‹å‰å®šç¾©ãƒ¦ãƒ¼ã‚¶ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´æ‰‹ç¶šãã‚’ç„¡åŠ¹ã«ã—ã¦ã„ã¾ã™ã€‚

___
ä»¥ä¸‹ã€HTTPSã§ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ã«æ¥ç¶šã—ãŸã„å ´åˆã®è¨­å®š


## 3) HTTPSé€šä¿¡ç”¨ã«è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™

ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã‚ªãƒ¬ã‚ªãƒ¬è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™
- [server.crt](/web/webgwfiles/server.crt)
- [server.key](/web/webgwfiles/server.key)

key ã¯ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºãŒèã‹ã‚Œãªã„ã‚ˆã†ã«å¤‰æ›´ã—ãŸã»ã†ãŒè‰¯ã„ã€‚
> openssl rsa -in ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ« -out ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«

## 4) Apacheã®SSLåŒ–

[3) HTTPSé€šä¿¡ç”¨ã«è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™](#3-httpsé€šä¿¡ç”¨ã«è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™) ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€default-ssl.conf ã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã¾ã™ã€‚

default-ssl.confã¯Apacheã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã€ä»¥ä¸‹ã«ã‚ã‚Šã¾ã™ã€‚
> /etc/apache2/sites-available/default-ssl.conf

ãã‚Œãã‚Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã«é…ç½®
ãƒ•ã‚¡ã‚¤ãƒ«å|é…ç½®å ´æ‰€
--|--|
server.crt|/etc/ssl/certs/server.crt
server.key|/etc/ssl/private/server.key

default-ssl.confã‚’æ›¸ãæ›ãˆã‚‹ãŸã‚ã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã€ä»¥ä¸‹ã®é …ç›®åã«ç”¨æ„ã—ãŸè¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ãƒ«ãƒ‘ã‚¹ã‚’è¨­å®š


é …ç›®å|ãƒ•ã‚¡ã‚¤ãƒ«æŒ‡å®š
--|--|
SSLCertificateFile|/etc/ssl/certs/server.crt
SSLCertificateKeyFile|/etc/ssl/private/server.key

ã“ã‚Œã‚‰ã®æ–‡å­—åˆ—ã®åŠ å·¥ã¯ã€Apacheã®[Dockerfile](/web/Dockerfile) ã®RUNã‚³ãƒãƒ³ãƒ‰ï¼ˆ7è¡Œç›®ä»¥é™ï¼‰ã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

default-ssl.confã®æ›¸ãæ›ãˆãŒçµ‚äº†ã—ãŸã‚‰ã€Apacheã®[Dockerfile](/web/Dockerfile) ã®RUNã‚³ãƒãƒ³ãƒ‰ï¼ˆ13ï½14è¡Œç›®ï¼‰ã§SSLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æœ‰åŠ¹åŒ–ã‚’è¡Œã†ãŸã‚ã€ä»¥ä¸‹å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
```
a2ensite default-ssl
a2enmod ssl
```

ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰æ™‚ã«ä¸Šè¨˜è¨­å®šãŒå®Œäº†ã™ã‚‹ãŸã‚ã€ã‚ã¨ã¯ã‚³ãƒ³ãƒ†ãƒŠã‚’é–‹å§‹ã™ã‚‹ã ã‘ã§httpsã§IRISã®ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚